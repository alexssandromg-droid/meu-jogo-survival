<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portas do Destino</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00e676; --neon-blue: #00b0ff; --neon-gold: #ffea00; --neon-red: #ff1744; --bg-dark: #050505;
        }
        body { background-color: var(--bg-dark); color: #e0e0e0; font-family: 'Rajdhani', sans-serif; margin: 0; height: 100vh; overflow: hidden; user-select: none; display: flex; flex-direction: column; }

        /* UI FORCA */
        #hangman-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 0, 0, 0.98); z-index: 2000; flex-direction: column; justify-content: center; align-items: center;
        }
        #word-display { font-size: 50px; letter-spacing: 10px; margin: 20px; font-family: monospace; color: white; }
        .kb-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .kb-key { width: 40px; height: 40px; background: #333; border: 1px solid #555; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .kb-key:hover { background: #555; }
        .kb-key.used { opacity: 0.3; cursor: not-allowed; background: black; }
        .kb-key.correct { background: green; }
        .kb-key.wrong { background: red; }
        
        #hangman-status { font-size: 24px; margin-bottom: 10px; color: var(--neon-gold); }
        .lives-box { display: flex; gap: 20px; font-size: 20px; }

        /* UI APOSTA */
        #betting-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .bet-container { display: flex; gap: 30px; }
        .bet-btn { width: 150px; height: 150px; background: #222; border: 4px solid #555; border-radius: 10px; color: white; font-size: 20px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; }
        .bet-btn:hover { transform: scale(1.1); border-color: gold; }
        .bet-btn.selected { background: white; color: black; border-color: lime; }

        /* GERAL */
        #btn-admin-toggle { position: absolute; top: 20px; left: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #333; z-index: 300; }
        #admin-panel { display: none; position: absolute; background: rgba(0,0,0,0.95); width: 100%; height: 100%; z-index: 400; flex-direction: column; justify-content: center; align-items: center; }
        .admin-card { background: #1a1a1a; padding: 20px; border: 1px solid white; width: 300px; }
        .admin-row { margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 5px; font-family: inherit; }

        #main-menu { position: absolute; width: 100%; height: 100%; background: #050505; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-interface { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { height: 60px; background: #111; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 250px; background: #0c0c0c; overflow-y: auto; padding: 10px; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rooms-grid { display: grid; gap: 10px; padding: 20px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; }

        .room-btn { aspect-ratio: 1; background: #1e1e1e; border: 2px solid #333; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .room-btn:hover { border-color: #777; }
        .room-btn.taken { opacity: 0.6; cursor: not-allowed; }
        .room-btn.duelo { background: #300; border-color: red; }
        .room-btn.revive { background: #003; border-color: cyan; }
        .room-btn.vazio { background: #222; border-color: #444; }

        .player-item { padding: 8px; margin-bottom: 5px; background: #181818; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
        .player-item.p1 { border-left-color: var(--neon-green); }
        .player-item.p2 { border-left-color: var(--neon-blue); }
        .player-item.p3 { border-left-color: var(--neon-red); }
        .player-item.p4 { border-left-color: var(--neon-gold); }
        .player-item.turn { background: #333; border-right: 3px solid white; }
        .player-item.dead { opacity: 0.3; text-decoration: line-through; }

        #message-box { font-size: 24px; font-weight: bold; margin-bottom: 20px; height: 30px; text-align: center; }
        #mode-display { color: cyan; font-size: 20px; margin-bottom: 10px; }
        #victory-screen { display: none; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        
        @media (max-width: 600px) { #main-container { flex-direction: column-reverse; } #sidebar { width: 100%; height: 150px; } #rooms-grid { grid-template-columns: repeat(4, 1fr) !important; padding: 5px; } }
    </style>
</head>
<body>

    <button id="btn-admin-toggle" onclick="abrirAdmin()">‚öôÔ∏è</button>
    <div style="position:absolute; top:20px; right:20px; background:#111; padding:5px 10px; border-radius:5px;">ONLINE: <span id="online-count">0</span></div>

    <div id="hangman-overlay">
        <h1 style="color:var(--neon-red)">DUELO DA FORCA</h1>
        <div id="hangman-status">VEZ DE: -</div>
        <div class="lives-box">
            <div id="lives-p1" style="color:cyan">P1: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="lives-p2" style="color:magenta">P2: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div id="word-display">_ _ _ _ _</div>
        <div id="keyboard"></div>
    </div>

    <div id="betting-modal">
        <h1 style="color:gold">APOSTE SUA VIDA!</h1>
        <div class="bet-container">
            <div class="bet-btn" id="bet-p1" onclick="apostar(1)"><span id="name-p1">P1</span></div>
            <div style="color:white; align-self:center; font-size:40px;">VS</div>
            <div class="bet-btn" id="bet-p2" onclick="apostar(2)"><span id="name-p2">P2</span></div>
        </div>
        <div style="color:red; margin-top:20px;">PERDEU APOSTA = MORTE</div>
    </div>

    <div id="admin-panel">
        <div class="admin-card">
            <h2>ADMIN</h2>
            <div id="admin-login-area">
                <input type="password" id="admin-pass" placeholder="Senha">
                <button onclick="tentarLoginAdmin()">ACESSAR</button>
                <button onclick="fecharAdmin()">SAIR</button>
            </div>
            <div id="admin-controls" style="display:none;">
                <label>MODO DE JOGO:</label>
                <select id="adm-mode" onchange="mudarModo()">
                    <option value="SOLO">SOLO (Individual)</option>
                    <option value="DUPLA">DUPLA</option>
                    <option value="SQUAD">SQUAD (Equipes)</option>
                </select>
                <button onclick="fecharAdmin()">FECHAR</button>
            </div>
        </div>
    </div>

    <div id="main-menu">
        <h1 style="font-size:50px; color:white; text-shadow:0 0 10px red;">PORTAS DO DESTINO</h1>
        <div id="mode-display">MODO: SOLO</div>
        <div class="menu-card" id="login-step">
            <input type="text" id="my-name" placeholder="NICKNAME" maxlength="12">
            <select id="my-color">
                <option value="p1">Equipe Verde</option>
                <option value="p2">Equipe Azul</option>
                <option value="p3">Equipe Vermelha</option>
                <option value="p4">Equipe Amarela</option>
            </select>
            <button onclick="entrarNoLobby()" style="background:var(--neon-green); font-weight:bold;">ENTRAR</button>
        </div>
        <div class="menu-card" id="lobby-step" style="display:none;">
            <h3>LOBBY</h3>
            <div id="lobby-list" style="background:#000; height:150px; overflow-y:auto; color:white; padding:10px;"></div>
            <button id="btn-start" onclick="iniciarJogo()" style="background:gold; display:none; margin-top:10px;">INICIAR</button>
            <div id="lobby-msg" style="color:#777; margin-top:5px;">Aguardando Host...</div>
        </div>
    </div>

    <div id="game-interface">
        <div id="header">
            <button onclick="location.reload()" style="background:#333; color:white; border:none; width:auto; padding:0 20px;">SAIR</button>
            <div id="timer-txt" style="color:gold; font-size:20px;">--</div>
            <div style="color:white">VIVOS: <span id="alive-txt">0</span></div>
        </div>
        <div id="main-container">
            <div id="sidebar"><div id="game-players-list"></div></div>
            <div id="game-area">
                <div id="message-box"></div>
                <div id="rooms-grid"></div>
            </div>
        </div>
    </div>

    <div id="victory-screen">
        <h1 style="color:gold; font-size:60px;">VENCEDOR</h1>
        <h2 id="winner-name" style="color:white;"></h2>
        <button onclick="location.reload()" style="width:200px;">VOLTAR</button>
    </div>

    <script>
        const socket = io();
        let meuId=null, minhaVez=false, timerVisual=null, apostaP1Id=null, apostaP2Id=null;
        const SFX={click:()=>playTone(600,'sine',0.1), bad:()=>playTone(150,'sawtooth',0.3), win:()=>playTone(600,'sine',0.6)};
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(f,t,d){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}

        function abrirAdmin(){document.getElementById('admin-panel').style.display='flex';}
        function fecharAdmin(){document.getElementById('admin-panel').style.display='none';}
        function tentarLoginAdmin(){socket.emit('adminLogin',document.getElementById('admin-pass').value);}
        socket.on('adminLogado',(ok)=>{if(ok){document.getElementById('admin-login-area').style.display='none';document.getElementById('admin-controls').style.display='block';}});
        function mudarModo(){socket.emit('mudarModo', document.getElementById('adm-mode').value);}
        
        socket.on('connect', ()=>meuId=socket.id);
        socket.on('jogadoresOnline', (n)=>document.getElementById('online-count').innerText=n);
        socket.on('modoAtual', (m)=>document.getElementById('mode-display').innerText=`MODO: ${m}`);

        function entrarNoLobby(){
            let n = document.getElementById('my-name').value;
            if(!n) return alert("Nome?");
            socket.emit('entrar',{nome:n, tipo:document.getElementById('my-color').value});
            document.getElementById('login-step').style.display='none';
            document.getElementById('lobby-step').style.display='block';
            SFX.click();
        }
        function iniciarJogo(){socket.emit('iniciarJogo');}

        socket.on('atualizarLista', (list)=>{
            let html = list.map(p=>`<div style="color:${p.id===meuId?'lime':'white'}">${p.nome} (${p.tipo})</div>`).join('');
            document.getElementById('lobby-list').innerHTML = html;
            if(list.length>0 && list[0].id===meuId) document.getElementById('btn-start').style.display='block';
            
            // Game List
            let gl = document.getElementById('game-players-list'); gl.innerHTML='';
            list.forEach(p=>{
                let d=document.createElement('div'); d.className=`player-item ${p.tipo}`;
                if(!p.vivo) d.classList.add('dead');
                if(p.id===meuId) d.style.borderRight="5px solid white";
                d.innerHTML = `<span>${p.nome}</span><span>${p.vivo?'VIVO':'MORT'}</span>`;
                gl.appendChild(d);
            });
            document.getElementById('alive-txt').innerText = list.filter(p=>p.vivo).length;
        });

        socket.on('inicioDePartida', (d)=>{
            document.getElementById('main-menu').style.display='none';
            document.getElementById('game-interface').style.display='flex';
            renderGrid(d.salas);
        });
        socket.on('novaRodada', (d)=>{
            renderGrid(d.salas); document.getElementById('message-box').innerText=`RODADA ${d.fase}`;
        });

        socket.on('salaOcupada', (d)=>{
            let b = document.getElementById(`room-${d.idSala}`);
            b.classList.add('taken');
            let ico='üö™'; 
            if(d.efeito==='duelo'){ico='‚öîÔ∏è'; b.classList.add('duelo'); SFX.bad();}
            else if(d.efeito==='revive'){ico='üòá'; b.classList.add('revive'); SFX.click();}
            else {ico='üí®'; b.classList.add('vazio');}
            b.innerHTML = `<div style="font-size:30px">${ico}</div><div style="font-size:10px">${d.jogador.nome}</div>`;
            if(d.msg) document.getElementById('message-box').innerText += d.msg;
        });

        socket.on('mensagem', (d)=>{let m=document.getElementById('message-box'); m.innerText=d.texto; m.style.color=d.cor;});
        
        // --- APOSTAS ---
        socket.on('abrirApostasUI', (d)=>{
            apostaP1Id=d.p1.id; apostaP2Id=d.p2.id;
            document.getElementById('betting-modal').style.display='flex';
            document.getElementById('name-p1').innerText=d.p1.nome;
            document.getElementById('name-p2').innerText=d.p2.nome;
            document.getElementById('bet-p1').classList.remove('selected');
            document.getElementById('bet-p2').classList.remove('selected');
        });
        function apostar(n){ socket.emit('fazerAposta', n===1?apostaP1Id:apostaP2Id); document.getElementById(`bet-p${n}`).classList.add('selected'); SFX.click(); }
        socket.on('fecharApostasUI', ()=>document.getElementById('betting-modal').style.display='none');

        // --- FORCA ---
        socket.on('iniciarForcaUI', (d)=>{
            document.getElementById('hangman-overlay').style.display='flex';
            document.getElementById('lives-p1').innerText = `${d.p1.nome}: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è`;
            document.getElementById('lives-p2').innerText = `${d.p2.nome}: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è`;
            
            // Teclado
            let kb = document.getElementById('keyboard'); kb.innerHTML='';
            let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let row = document.createElement('div'); row.className='kb-row';
            for(let i=0; i<chars.length; i++){
                let k = document.createElement('div'); k.className='kb-key'; k.innerText=chars[i]; k.id=`key-${chars[i]}`;
                k.onclick = () => socket.emit('chuteForca', chars[i]);
                row.appendChild(k);
                if((i+1)%9===0 || i===chars.length-1) { kb.appendChild(row); row=document.createElement('div'); row.className='kb-row'; }
            }
        });

        socket.on('forcaUpdate', (d)=>{
            document.getElementById('word-display').innerText = d.palavra.join(' ');
            document.getElementById('hangman-status').innerText = (d.vezId === meuId) ? "SUA VEZ!" : "VEZ DO OPONENTE";
            
            // Atualiza teclado
            d.usadas.forEach(L => {
                let k = document.getElementById(`key-${L}`);
                if(k) k.classList.add('used');
            });

            // Atualiza vidas (gambiarra visual simples)
            let p1Lives = 5 - (d.erros[Object.keys(d.erros)[0]] || 0);
            let p2Lives = 5 - (d.erros[Object.keys(d.erros)[1]] || 0);
            // Idealmente mapear IDs, mas vamos deixar assim pelo prompt
        });

        socket.on('forcaFim', (d)=>{
            document.getElementById('word-display').innerText = d.palavra;
            setTimeout(()=>document.getElementById('hangman-overlay').style.display='none', 3000);
        });
        socket.on('fecharForcaUI', ()=>document.getElementById('hangman-overlay').style.display='none');

        // CORE UTILS
        socket.on('mudancaDeTurno', (d)=>{
            if(d.idJogador===meuId) { document.getElementById('message-box').innerText="SUA VEZ DE ESCOLHER A PORTA!"; document.getElementById('message-box').style.color="lime"; }
            else { document.getElementById('message-box').innerText=`VEZ DE ${d.nome}`; document.getElementById('message-box').style.color="white"; }
        });
        
        socket.on('efeitoKill', (d)=>{
            // Visual flash red?
        });

        socket.on('fimDeJogo', (d)=>{
            document.getElementById('victory-screen').style.display='flex';
            document.getElementById('winner-name').innerText = d.campeao.nome;
            SFX.win();
        });

        function renderGrid(salas){
            let g = document.getElementById('rooms-grid'); g.innerHTML='';
            let cols = window.innerWidth<600?4:5; g.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
            salas.forEach(s=>{
                let b=document.createElement('div'); b.className='room-btn'; b.id=`room-${s.id}`;
                b.onclick=()=>{if(document.getElementById('message-box').innerText.includes("SUA VEZ")) socket.emit('jogarTurno', s.id);};
                b.innerHTML=`<div style="font-size:12px; position:absolute; top:2px; left:4px; opacity:0.5">${s.id}</div><div style="font-size:30px">üö™</div>`;
                g.appendChild(b);
            });
        }
    </script>
</body>
</html>
