<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Royale: EXPURGO</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00e676; --neon-blue: #00b0ff; --neon-gold: #ffea00;
            --neon-red: #ff1744; --neon-purple: #d500f9;
            --bg-dark: #080808; --panel-bg: rgba(20, 20, 20, 0.95);
        }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Rajdhani', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; user-select: none; }

        /* --- TABULEIRO MODERNO --- */
        #board-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #1a0000 0%, #000 100%);
            z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
        }
        #board-title { font-size: 40px; color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); margin-bottom: 10px; }
        
        .board-track {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            background: #222; padding: 15px; border-radius: 10px; border: 2px solid #444;
            max-width: 600px; width: 95%; position: relative;
        }
        .board-cell {
            aspect-ratio: 1; background: #333; border-radius: 5px; border: 1px solid #555;
            display: flex; justify-content: center; align-items: center; color: #777; font-weight: bold;
            position: relative;
        }
        .board-cell.trap { background: repeating-linear-gradient(45deg, #400, #400 5px, #200 5px, #200 10px); border-color: red; }
        .board-cell.finish { background: #ffd700; color: black; border-color: white; box-shadow: 0 0 15px gold; }
        
        /* PE√ïES DOS JOGADORES */
        .p-token {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid white;
            display: flex; justify-content: center; align-items: center; font-size: 10px; color: white;
            font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.5); z-index: 10;
            position: absolute; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* DADO */
        #dice-container { margin-top: 20px; display: flex; flex-direction: column; align-items: center; }
        #dice-display {
            width: 80px; height: 80px; background: white; color: black; border-radius: 10px;
            display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold;
            box-shadow: 0 0 20px rgba(255,255,255,0.5); cursor: pointer; transition: 0.1s;
        }
        #dice-display:active { transform: scale(0.9); }
        #dice-display.disabled { opacity: 0.3; cursor: not-allowed; background: #555; }
        
        @keyframes rollAnim { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rolling { animation: rollAnim 0.2s infinite linear; }

        /* --- APOSTAS --- */
        #betting-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1500; flex-direction: column; justify-content: center; align-items: center;
        }
        .bet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 500px; width: 90%; }
        .bet-card {
            background: #222; border: 2px solid #444; padding: 20px; text-align: center;
            border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .bet-card:hover { border-color: var(--neon-green); background: #2a2a2a; }
        .bet-card.selected { background: var(--neon-green); color: black; border-color: white; transform: scale(1.05); }

        /* --- VOTA√á√ÉO --- */
        #voting-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .vote-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 800px; padding: 10px; overflow-y: auto; max-height: 70vh; }
        .vote-btn { background: #333; border: 1px solid #555; color: white; padding: 15px; border-radius: 5px; cursor: pointer; font-family: inherit; text-transform: uppercase; }
        .vote-btn:hover { background: var(--neon-red); border-color: white; }

        /* --- JOGO PRINCIPAL --- */
        #game-interface { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { height: 60px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 240px; background: #0c0c0c; border-right: 1px solid #222; padding: 10px; overflow-y: auto; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        #rooms-grid { display: grid; gap: 8px; padding: 20px; width: 100%; max-width: 700px; max-height: 80vh; overflow-y: auto; }
        
        .room-btn { 
            aspect-ratio: 1; background: #1e1e1e; border: 2px solid #333; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; 
            transition: all 0.2s;
        }
        .room-btn:hover { border-color: #666; background: #252525; }
        .room-btn.taken { opacity: 0.7; cursor: not-allowed; }
        .room-btn.gas { background: #331100; border-color: #ff3d00; }
        .room-btn.vida { background: #002200; border-color: #00e676; }
        .room-btn.escudo { background: #001133; border-color: #00b0ff; }
        
        .player-item { padding: 8px; margin-bottom: 5px; background: #181818; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; border-left: 3px solid transparent; }
        .player-item.turn { background: #2a2a2a; border-left-color: var(--neon-gold); }
        .player-item.dead { opacity: 0.4; text-decoration: line-through; }
        
        #message-box { font-size: 24px; font-weight: bold; margin-bottom: 20px; height: 30px; text-shadow: 0 2px 5px black; text-align: center; }
        
        /* MENU & ADMIN */
        #main-menu { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input, select, button { font-family: 'Rajdhani', sans-serif; }
        .btn-menu { padding: 15px 40px; font-size: 20px; background: var(--neon-green); border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-menu:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--neon-green); }
        
        /* UTILITARIOS */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="board-overlay">
        <div id="board-title">CORRIDA MORTAL</div>
        <div id="board-subtitle" style="color:#aaa; margin-bottom:10px;">TOP 2 SOBREVIVEM</div>
        
        <div class="board-track" id="board-track"></div>
        
        <div id="dice-container">
            <div id="dice-display" onclick="rolarDado()" class="disabled">üé≤</div>
            <div id="dice-msg" style="margin-top:10px; font-size:18px; color:var(--neon-blue);">Aguarde...</div>
        </div>
    </div>

    <div id="voting-modal">
        <h1 style="color:var(--neon-blue)">QUEM DEVE IR PARA O JOGO?</h1>
        <div class="vote-list" id="vote-list"></div>
        <div style="margin-top:10px; color:#777" id="vote-status">Selecione para eliminar...</div>
    </div>

    <div id="betting-modal">
        <h1 style="color:var(--neon-gold)">QUEM SE SALVA?</h1>
        <div style="color:#aaa; margin-bottom:20px;">Se errar e n√£o tiver escudo, voc√™ morre.</div>
        <div class="bet-grid" id="bet-list"></div>
    </div>

    <div id="main-menu">
        <h1 style="font-size:60px; color:transparent; background:linear-gradient(to right, #00e676, #00b0ff); -webkit-background-clip:text;">SURVIVAL ROYALE</h1>
        <input type="text" id="my-name" placeholder="SEU NICKNAME" style="padding:10px; font-size:18px; text-align:center; background:#111; color:white; border:1px solid #333; margin-bottom:10px;">
        <button class="btn-menu" onclick="entrar()">ENTRAR</button>
        <button onclick="socket.emit('iniciarJogo')" style="margin-top:20px; background:transparent; border:1px solid #333; color:#555; cursor:pointer; padding:5px;">(Host Start)</button>
    </div>

    <div id="game-interface">
        <div id="header">
            <button onclick="location.reload()" style="background:#333; color:white; border:none; padding:5px 15px; cursor:pointer;">SAIR</button>
            <div style="font-weight:bold; font-size:20px; color:var(--neon-gold)" id="timer-txt">--</div>
            <div style="font-size:14px;">VIVOS: <span id="alive-txt" style="color:white">0</span></div>
        </div>
        <div id="main-container">
            <div id="sidebar"><div id="players-list"></div></div>
            <div id="game-area">
                <div id="message-box"></div>
                <div id="rooms-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let meuId = null, minhaVez = false, timerVisual = null;
        let boardPlayersMap = {}; // Maps ID to Color

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(f,t,d){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}
        const SFX={click:()=>playTone(600,'sine',0.1),gas:()=>playTone(150,'sawtooth',0.4),life:()=>playTone(800,'triangle',0.2),dice:()=>playTone(400,'square',0.1),win:()=>playTone(600,'sine',0.6)};

        socket.on('connect', () => meuId=socket.id);

        function entrar(){
            let n = document.getElementById('my-name').value;
            if(!n) return alert("Digite um nome");
            socket.emit('entrar', {nome:n, tipo:'p1'});
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-interface').style.display='flex';
            SFX.click();
        }

        // --- VOTA√á√ÉO ---
        socket.on('abrirVotacao', (candidatos) => {
            document.getElementById('voting-modal').style.display = 'flex';
            let list = document.getElementById('vote-list');
            list.innerHTML = '';
            candidatos.forEach(c => {
                let btn = document.createElement('button');
                btn.className = 'vote-btn';
                btn.innerText = c.nome;
                btn.onclick = () => {
                    socket.emit('enviarVoto', c.id);
                    document.getElementById('vote-status').innerText = "VOTO COMPUTADO";
                    SFX.click();
                    document.querySelectorAll('.vote-btn').forEach(b=>b.disabled=true);
                };
                list.appendChild(btn);
            });
        });
        socket.on('fecharVotacao', () => document.getElementById('voting-modal').style.display='none');
        socket.on('progressoVotacao', (d) => document.getElementById('vote-status').innerText = `Votos: ${d.atual}/${d.total}`);

        // --- APOSTAS ---
        socket.on('abrirApostasUI', (participantes) => {
            document.getElementById('betting-modal').style.display = 'flex';
            let list = document.getElementById('bet-list');
            list.innerHTML = '';
            participantes.forEach(p => {
                let div = document.createElement('div');
                div.className = 'bet-card';
                div.innerHTML = `<div style="font-size:20px; font-weight:bold;">${p.nome}</div>`;
                div.onclick = () => {
                    socket.emit('fazerAposta', p.id);
                    document.querySelectorAll('.bet-card').forEach(c=>c.classList.remove('selected'));
                    div.classList.add('selected');
                    SFX.click();
                };
                list.appendChild(div);
            });
        });
        socket.on('fecharApostasUI', () => document.getElementById('betting-modal').style.display='none');

        // --- TABULEIRO ---
        socket.on('iniciarBoardUI', (d) => {
            document.getElementById('board-overlay').style.display = 'flex';
            
            // Setup Track
            const track = document.getElementById('board-track');
            track.innerHTML = '';
            
            for(let i=0; i<=d.tamanho; i++) {
                let cell = document.createElement('div');
                cell.className = 'board-cell';
                if(i===6) { cell.classList.add('life'); cell.innerText = 'üöÄ'; } // Boost
                if(i===11) { cell.classList.add('trap'); cell.innerText = 'üíÄ'; } // Azar
                if(i===d.tamanho) { cell.classList.add('finish'); cell.innerText = 'üèÅ'; }
                else if(i!==6 && i!==11) cell.innerText = i;
                
                cell.id = `cell-${i}`;
                track.appendChild(cell);
            }

            // Create Players Tokens
            const colors = ['#ff1744', '#00e676', '#00b0ff', '#ffea00'];
            d.players.forEach((p, idx) => {
                let token = document.createElement('div');
                token.className = 'p-token';
                token.style.backgroundColor = colors[idx % colors.length];
                token.innerText = p.nome.substring(0,2).toUpperCase();
                token.id = `token-${p.id}`;
                // Start at 0
                document.getElementById('cell-0').appendChild(token);
            });
        });

        socket.on('vezBoard', (d) => {
            let dice = document.getElementById('dice-display');
            let msg = document.getElementById('dice-msg');
            if(d.id === meuId) {
                dice.classList.remove('disabled');
                dice.innerText = "üé≤";
                msg.innerText = "SUA VEZ! CLIQUE NO DADO!";
                playTone(600,'sine',0.2); // Alert
            } else {
                dice.classList.add('disabled');
                dice.innerText = "‚è≥";
                msg.innerText = `VEZ DE ${d.nome}`;
            }
        });

        function rolarDado() {
            let d = document.getElementById('dice-display');
            if(!d.classList.contains('disabled')) {
                d.classList.add('rolling');
                socket.emit('pedirDado');
                SFX.click();
            }
        }

        socket.on('dadoRolado', (d) => {
            let dice = document.getElementById('dice-display');
            dice.classList.remove('rolling');
            dice.innerText = d.dado;
            SFX.dice();

            // Mover Token
            let token = document.getElementById(`token-${d.id}`);
            let cell = document.getElementById(`cell-${d.pos}`);
            if(token && cell) {
                cell.appendChild(token);
            }
            if(d.msg) document.getElementById('dice-msg').innerText = d.msg;
        });

        socket.on('jogadorSalvoBoard', (d) => {
            let t = document.getElementById(`token-${d.id}`);
            if(t) t.style.opacity = 0.5; // Visual feedback that they are safe/done
        });

        socket.on('fecharBoardUI', () => document.getElementById('board-overlay').style.display='none');

        // --- CORE GAME ---
        socket.on('novaRodada', (d) => {
            document.getElementById('board-overlay').style.display='none';
            renderGrid(d.salas);
            document.getElementById('message-box').innerText = `RODADA ${d.fase}`;
        });

        socket.on('atualizarLista', (list) => {
            let div = document.getElementById('players-list');
            div.innerHTML = '';
            list.forEach(p => {
                let el = document.createElement('div');
                el.className = `player-item ${p.vivo?'':'dead'}`;
                if(p.id===meuId) el.style.borderLeftColor = 'lime';
                let st = p.vivo ? "‚ù§Ô∏è".repeat(p.vidas) : "üíÄ";
                if(p.temEscudo) st = "üõ°Ô∏è";
                el.innerHTML = `<span>${p.nome}</span><span>${st}</span>`;
                div.appendChild(el);
            });
            document.getElementById('alive-txt').innerText = list.filter(j=>j.vivo).length;
        });

        socket.on('mudancaDeTurno', (d) => {
            let t = d.tempo;
            let msg = document.getElementById('message-box');
            let time = document.getElementById('timer-txt');
            
            clearInterval(timerVisual);
            timerVisual = setInterval(() => {
                time.innerText = t--;
                if(t<0) clearInterval(timerVisual);
            }, 1000);

            if(d.idJogador === meuId) {
                msg.innerText = "SUA VEZ DE ESCOLHER!";
                msg.style.color = "var(--neon-green)";
            } else {
                msg.innerText = `VEZ DE ${d.nome}`;
                msg.style.color = "white";
            }
        });

        socket.on('salaOcupada', (d) => {
            let btn = document.getElementById(`room-${d.idSala}`);
            if(btn) {
                btn.classList.add('taken');
                btn.classList.add(d.efeito);
                let ico = 'üö™';
                if(d.efeito==='gas') ico='‚ò†Ô∏è';
                if(d.efeito==='vida') ico='‚ù§Ô∏è';
                if(d.efeito==='escudo') ico='üõ°Ô∏è';
                btn.innerHTML = `<div style="font-size:24px">${ico}</div><div style="font-size:10px;position:absolute;bottom:2px">${d.jogador.nome}</div>`;
                if(d.efeito==='gas') SFX.gas(); else SFX.click();
            }
        });

        socket.on('mensagem', (d) => {
            let m = document.getElementById('message-box');
            m.innerText = d.texto; m.style.color = d.cor;
        });

        socket.on('inicioDePartida', (d) => renderGrid(d.salas));

        function renderGrid(salas) {
            let g = document.getElementById('rooms-grid');
            g.innerHTML = '';
            let cols = window.innerWidth<600 ? 4 : 5;
            g.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            salas.forEach(s => {
                let b = document.createElement('div');
                b.className = 'room-btn';
                b.id = `room-${s.id}`;
                b.onclick = () => {
                    if(document.getElementById('message-box').innerText.includes("SUA VEZ")) {
                        socket.emit('jogarTurno', s.id);
                    }
                };
                b.innerHTML = `<div style="font-size:12px; position:absolute; top:2px; left:4px; opacity:0.5">${s.id}</div><div style="font-size:24px">üö™</div>`;
                g.appendChild(b);
            });
        }
    </script>
</body>
</html>
