<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Royale Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00e676;
            --neon-blue: #00b0ff;
            --neon-gold: #ffea00;
            --bg-dark: #050505;
            --card-bg: #111;
        }
        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        /* --- UI COMPONENTES --- */
        #btn-admin-toggle {
            position: absolute; top: 20px; left: 20px;
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: #333; transition: 0.3s; z-index: 300;
        }
        #btn-admin-toggle:hover { color: white; transform: rotate(90deg); }

        #admin-panel {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 400; overflow-y: auto;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .admin-card {
            background: #1a1a1a; padding: 20px; border: 1px solid var(--neon-blue);
            border-radius: 10px; width: 320px; text-align: left; margin: 20px 0;
        }
        .admin-row { margin-bottom: 15px; }
        .admin-row label { display: block; color: #aaa; font-size: 14px; margin-bottom: 5px; }
        .admin-row input, .admin-row select { 
            width: 100%; padding: 8px; background: #000; border: 1px solid #444; color: white; box-sizing: border-box; 
        }
        .btn-admin-save { background: var(--neon-blue); color: black; border: none; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn-admin-close { background: #333; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; margin-top: 10px; }

        .online-badge {
            position: absolute; top: 20px; right: 20px;
            background: #111; border: 1px solid #333;
            padding: 5px 15px; border-radius: 20px;
            color: var(--neon-green); font-size: 14px; display: flex; align-items: center; gap: 5px;
        }
        .online-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 5px var(--neon-green); }

        /* --- MENU --- */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; transition: opacity 0.5s;
        }
        .logo-title {
            font-size: 60px; color: transparent;
            background: linear-gradient(to right, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            text-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; text-align: center;
        }
        .menu-card {
            background: rgba(20, 20, 20, 0.9);
            padding: 30px; border-radius: 15px; border: 1px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); text-align: center; width: 90%; max-width: 400px;
        }
        
        .hall-fama-container { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; }
        .rank-list { text-align: left; font-size: 14px; color: #ccc; max-height: 100px; overflow-y: auto; }
        .rank-item { padding: 5px 0; border-bottom: 1px dashed #333; display: flex; justify-content: space-between; }
        .rank-item span { color: var(--neon-gold); }

        .btn-large {
            padding: 15px; width: 100%; font-size: 20px; font-weight: bold;
            background: var(--neon-green); color: black; border: none; border-radius: 8px;
            cursor: pointer; text-transform: uppercase; transition: 0.3s; margin-top: 10px;
        }
        .btn-large:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 230, 118, 0.5); }
        
        input[type="text"], select {
            padding: 15px; background: #000; border: 1px solid #444; color: white;
            font-family: 'Rajdhani', sans-serif; font-size: 18px; text-align: center; border-radius: 8px;
            outline: none; width: 100%; margin-bottom: 10px; box-sizing: border-box;
        }

        /* --- JOGO --- */
        #game-interface { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { height: 60px; background: #111; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 250px; background: #0a0a0a; border-right: 1px solid #222; overflow-y: auto; padding: 10px; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rooms-grid { display: grid; gap: 10px; padding: 20px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; }

        .room-btn {
            aspect-ratio: 1; background: #1e1e1e; border: 1px solid #333; border-radius: 8px;
            color: #555; cursor: pointer; position: relative; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: all 0.1s;
        }
        .room-btn:hover { background: #2a2a2a; border-color: #777; }
        .room-btn.taken { cursor: not-allowed; border-color: #444; background: #111; }
        .room-btn.gas { background: #2e1e05 !important; border-color: #d35400 !important; }
        .room-btn.life { background: #052e05 !important; border-color: #27ae60 !important; }
        .room-btn.key { background: #2e2805 !important; border-color: #f1c40f !important; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4) inset; }
        .room-btn.exploded { background: #500 !important; border-color: red !important; animation: shake 0.5s; }

        .room-number { position: absolute; top: 5px; left: 8px; font-weight: bold; color: rgba(255,255,255,0.3); font-size: 14px; }
        .room-content { font-size: 30px; }
        .occupant-name { font-size: 12px; margin-top: 5px; color: #aaa; font-weight: bold; max-width: 90%; overflow: hidden; white-space: nowrap; }

        .player-item { background: #151515; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; }
        .player-item.p1 { border-left-color: var(--neon-green); }
        .player-item.p2 { border-left-color: var(--neon-blue); }
        .player-item.p3 { border-left-color: #d500f9; }
        .player-item.p4 { border-left-color: var(--neon-gold); }
        .player-item.turn { background: #222; border-right: 3px solid var(--neon-gold); }
        .player-item.dead { text-decoration: line-through; opacity: 0.4; }
        
        #message-box { font-size: 24px; font-weight: bold; margin-bottom: 10px; height: 35px; text-shadow: 0 2px 10px black; }
        #timer-txt { font-size: 24px; color: var(--neon-gold); font-family: monospace; font-weight: bold; }

        #victory-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        
        @keyframes shake { 0% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} 100% {transform: translateX(0);} }
        @media (max-width: 600px) {
            #main-container { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 150px; }
            #rooms-grid { grid-template-columns: repeat(4, 1fr) !important; padding: 5px; }
            .logo-title { font-size: 40px; }
        }
    </style>
</head>
<body>

    <button id="btn-admin-toggle" onclick="abrirAdmin()">‚öôÔ∏è</button>
    <div class="online-badge"><div class="online-dot"></div><span id="online-count">1</span> ONLINE</div>

    <div id="admin-panel">
        <div class="admin-card">
            <h2 style="color:var(--neon-blue); margin-top:0;">ADMINISTRADOR</h2>
            <div id="admin-login-area">
                <div class="admin-row"><label>Senha:</label><input type="password" id="admin-pass"></div>
                <button class="btn-admin-save" onclick="tentarLoginAdmin()">ACESSAR</button>
                <button class="btn-admin-close" onclick="fecharAdmin()">CANCELAR</button>
            </div>
            <div id="admin-controls" style="display:none;">
                <div class="admin-row">
                    <label>M√°ximo Jogadores (Bots):</label><input type="number" id="conf-max" value="20">
                </div>
                <div class="admin-row">
                    <label>Vidas Iniciais:</label><input type="number" id="conf-vidas" value="2">
                </div>
                <div class="admin-row">
                    <label>Chance de Chave (0.1 = 10%):</label><input type="number" id="conf-chave" step="0.1" value="0.2">
                </div>
                <div class="admin-row">
                    <label>Chance de G√°s (0.4 = 40%):</label><input type="number" id="conf-gas" step="0.1" value="0.4">
                </div>
                <div class="admin-row">
                    <label>Multiplicador Portas:</label><input type="number" id="conf-portas" step="0.1" value="1.2">
                </div>
                <div class="admin-row">
                    <label>Velocidade Bot (ms):</label>
                    <select id="conf-speed">
                        <option value="1000">Lento (1s)</option>
                        <option value="500">Normal (0.5s)</option>
                        <option value="100">Flash (0.1s)</option>
                    </select>
                </div>
                <button class="btn-admin-save" onclick="salvarConfig()">üíæ SALVAR E REINICIAR</button>
                <button class="btn-admin-close" style="background:#d32f2f" onclick="zerarRank()">üóëÔ∏è ZERAR RANK</button>
                <button class="btn-admin-close" onclick="fecharAdmin()">FECHAR</button>
            </div>
        </div>
    </div>

    <div id="main-menu">
        <div class="logo-title">SURVIVAL<br>ROYALE</div>
        <div class="menu-card" id="login-step">
            <h3 style="margin:0 0 20px 0; color:#aaa;">IDENTIFICA√á√ÉO</h3>
            <input type="text" id="my-name" placeholder="SEU NICKNAME" maxlength="12">
            <select id="my-color">
                <option value="p1">Equipe Verde</option>
                <option value="p2">Equipe Azul</option>
                <option value="p3">Equipe Roxa</option>
                <option value="p4">Equipe Amarela</option>
            </select>
            <button class="btn-large" onclick="entrarNoLobby()">ENTRAR</button>
            <div class="hall-fama-container">
                <div class="rank-title">üèÜ HALL DA FAMA üèÜ</div>
                <div class="rank-list" id="rank-list-ui"><div style="text-align:center;">...</div></div>
            </div>
        </div>
        <div class="menu-card" id="lobby-step" style="display:none;">
            <h3 style="color:white;">SALA DE ESPERA</h3>
            <div style="color:#777; margin-bottom:10px;">Aguarde amigos ou inicie com Bots</div>
            <div id="lobby-list" style="background:#000; padding:10px; border-radius:5px; height:100px; overflow-y:auto; margin-bottom:15px; text-align:left;"></div>
            <button id="btn-start" class="btn-large" style="background:var(--neon-gold); display:none;" onclick="iniciarJogo()">INICIAR PARTIDA</button>
            <div class="lobby-status" id="lobby-msg">Aguardando Host...</div>
        </div>
    </div>

    <div id="game-interface">
        <div id="header">
            <button class="btn-back-header" style="background:#333; color:white; border:none; padding:5px 15px; cursor:pointer;" onclick="location.reload()">SAIR</button>
            <div id="timer-txt">--</div>
            <div style="font-weight:bold; font-size:14px;">VIVOS: <span id="alive-txt" style="color:white;">20</span></div>
        </div>
        <div id="main-container">
            <div id="sidebar"><div id="game-players-list"></div></div>
            <div id="game-area">
                <div id="message-box"></div>
                <div id="rooms-grid"></div>
            </div>
        </div>
    </div>

    <div id="victory-screen">
        <h1 style="color:var(--neon-gold); font-size: 50px;">VENCEDOR</h1>
        <h2 id="winner-name" style="color:white; font-size: 40px;">-</h2>
        <button class="btn-large" style="width:200px; margin-top:30px;" onclick="location.reload()">VOLTAR</button>
    </div>

    <script>
        const socket = io();
        let meuId = null;
        let minhaVez = false;
        let timerVisual = null;

        // --- ADMIN ---
        function abrirAdmin() { document.getElementById('admin-panel').style.display = 'flex'; }
        function fecharAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
        function tentarLoginAdmin() { socket.emit('adminLogin', document.getElementById('admin-pass').value); }
        socket.on('adminLogado', (ok) => {
            if(ok) { document.getElementById('admin-login-area').style.display='none'; document.getElementById('admin-controls').style.display='block'; }
            else alert("Senha errada!");
        });
        socket.on('configAtual', (c) => {
            document.getElementById('conf-max').value = c.maxJogadores;
            document.getElementById('conf-vidas').value = c.vidasIniciais;
            document.getElementById('conf-speed').value = c.velocidadeBot;
            document.getElementById('conf-portas').value = c.fatorPortas;
            document.getElementById('conf-gas').value = c.chanceGas;
            document.getElementById('conf-chave').value = c.chanceChave;
        });
        function salvarConfig() {
            socket.emit('adminSalvarConfig', {
                maxJogadores: document.getElementById('conf-max').value,
                vidasIniciais: document.getElementById('conf-vidas').value,
                velocidadeBot: document.getElementById('conf-speed').value,
                fatorPortas: document.getElementById('conf-portas').value,
                chanceGas: document.getElementById('conf-gas').value,
                chanceChave: document.getElementById('conf-chave').value
            });
            fecharAdmin();
        }
        function zerarRank() { if(confirm("Zerar?")) socket.emit('adminZerarRank'); }

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(f, t, d) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
        }
        const SFX = { click:()=>playTone(600,'sine',0.1), start:()=>playTone(400,'square',0.3), gas:()=>playTone(150,'sawtooth',0.4), life:()=>playTone(800,'triangle',0.2), key:()=>playTone(1200,'sine',0.5), explode:()=>playTone(60,'square',0.8), win:()=>playTone(600,'sine',0.6) };

        // --- LOGICA ---
        socket.on('connect', () => { meuId = socket.id; });
        socket.on('jogadoresOnline', (n) => document.getElementById('online-count').innerText = n);
        
        socket.on('atualizarRanking', (lista) => {
            document.getElementById('rank-list-ui').innerHTML = lista.length ? lista.map(r=>`<div class="rank-item"><span>üèÜ ${r.nome}</span><div style="font-size:10px; color:#555;">${r.data}</div></div>`).join('') : '<div style="text-align:center; padding:5px;">Vazio</div>';
        });

        function entrarNoLobby() {
            if(!document.getElementById('my-name').value) return alert("Nome?");
            socket.emit('entrar', { nome: document.getElementById('my-name').value, tipo: document.getElementById('my-color').value });
            document.getElementById('login-step').style.display = 'none';
            document.getElementById('lobby-step').style.display = 'block';
            SFX.click();
        }
        function iniciarJogo() { socket.emit('iniciarJogo'); }

        socket.on('atualizarLista', (jogadores) => {
            document.getElementById('lobby-list').innerHTML = jogadores.map(j => `<div style="color:${j.id===meuId?'#00e676':'white'}">${j.nome}</div>`).join('');
            if(jogadores.length>0 && jogadores[0].id===meuId) { document.getElementById('btn-start').style.display='block'; document.getElementById('lobby-msg').style.display='none'; }
            
            const gl = document.getElementById('game-players-list'); gl.innerHTML = '';
            jogadores.forEach(p => {
                let div = document.createElement('div'); div.className = `player-item ${p.tipo}`; div.id=`plist-${p.id}`;
                if(!p.vivo) div.classList.add('dead');
                let hp = p.vivo ? "‚ù§Ô∏è".repeat(p.vidas) : "üíÄ";
                if(p.temChave) hp = "üîë PROTEGIDO";
                div.innerHTML = `<div>${p.nome}</div><div style="font-size:10px">${hp}</div>`;
                gl.appendChild(div);
            });
            document.getElementById('alive-txt').innerText = jogadores.filter(j=>j.vivo).length;
        });

        socket.on('inicioDePartida', (d) => {
            document.getElementById('main-menu').style.display='none'; document.getElementById('game-interface').style.display='flex';
            renderizarGrid(d.salas); SFX.start();
        });
        socket.on('novaRodada', (d) => { renderizarGrid(d.salas); document.getElementById('message-box').innerText=`N√çVEL ${d.fase}`; SFX.start(); });

        socket.on('mudancaDeTurno', (d) => {
            minhaVez = (d.idJogador === meuId); clearInterval(timerVisual);
            document.querySelectorAll('.player-item').forEach(e=>e.classList.remove('turn'));
            if(document.getElementById(`plist-${d.idJogador}`)) document.getElementById(`plist-${d.idJogador}`).classList.add('turn');
            
            let t = d.tempo; document.getElementById('timer-txt').innerText = t;
            let box = document.getElementById('message-box');
            if(minhaVez) { box.innerText=`SUA VEZ!`; box.style.color="var(--neon-green)"; document.getElementById('timer-txt').style.color="var(--neon-green)"; }
            else { box.innerText=`VEZ DE ${d.nome}`; box.style.color="white"; document.getElementById('timer-txt').style.color="var(--neon-gold)"; }
            
            timerVisual = setInterval(()=>{ t--; document.getElementById('timer-txt').innerText=t; if(t<=0) clearInterval(timerVisual); },1000);
        });

        socket.on('salaOcupada', (d) => {
            clearInterval(timerVisual); document.getElementById('timer-txt').innerText="--";
            let b = document.getElementById(`room-${d.idSala}`);
            b.classList.add('taken');
            let c = '#555';
            if(d.jogador.tipo==='p1') c='var(--neon-green)'; if(d.jogador.tipo==='p2') c='var(--neon-blue)';
            if(d.jogador.tipo==='p3') c='#d500f9'; if(d.jogador.tipo==='p4') c='var(--neon-gold)';
            b.style.borderColor = c;
            document.getElementById(`name-${d.idSala}`).innerText = d.jogador.nome;
            let ic = document.getElementById(`icon-${d.idSala}`);
            
            if(d.efeito==='gas') { b.classList.add('gas'); ic.innerText='‚ò†Ô∏è'; SFX.gas(); }
            else if(d.efeito==='vida') { b.classList.add('life'); ic.innerText='üü¢'; SFX.life(); }
            else if(d.efeito==='chave') { b.classList.add('key'); ic.innerText='üîë'; SFX.key(); }
            else { ic.innerText='üòê'; SFX.click(); }
        });

        socket.on('mensagem', (d) => { let b=document.getElementById('message-box'); b.innerText=d.texto; b.style.color=d.cor; });
        socket.on('efeitoExplosao', (d) => {
            let b=document.getElementById(`room-${d.idSala}`);
            if(b) { b.classList.add('exploded'); document.getElementById(`icon-${d.idSala}`).innerText='üí•'; SFX.explode(); }
        });
        socket.on('fimDeJogo', (d) => {
            document.getElementById('victory-screen').style.display='flex'; document.getElementById('winner-name').innerText=d.campeao.nome; SFX.win();
        });

        function renderizarGrid(salas) {
            const g = document.getElementById('rooms-grid'); g.innerHTML='';
            let cols = window.innerWidth<600?4:5; g.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
            salas.forEach(s => {
                let b = document.createElement('button'); b.className='room-btn'; b.id=`room-${s.id}`;
                b.onclick=()=>{if(minhaVez) socket.emit('jogarTurno', s.id);};
                b.innerHTML=`<div class="room-number">${s.id}</div><div class="room-content" id="icon-${s.id}">üö™</div><div class="occupant-name" id="name-${s.id}"></div>`;
                g.appendChild(b);
            });
        }
    </script>
</body>
</html>
