<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Royale 5 GAMES</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00e676; --neon-blue: #00b0ff; --neon-gold: #ffea00;
            --neon-red: #ff1744; --bg-dark: #050505;
        }
        body { background-color: var(--bg-dark); color: #e0e0e0; font-family: 'Rajdhani', sans-serif; margin: 0; height: 100vh; overflow: hidden; user-select: none; display: flex; flex-direction: column; }

        /* --- MINIGAME OVERLAYS --- */
        .minigame-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(10, 10, 10, 0.98); z-index: 2000 !important;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .mg-title { font-size: 40px; color: white; margin-bottom: 20px; text-shadow: 0 0 10px white; }
        .mg-vs { font-size: 20px; color: #aaa; margin-bottom: 30px; }

        /* BOARD */
        .board-cell { width: 35px; height: 35px; border: 1px solid #444; background: #222; display: flex; justify-content: center; align-items: center; font-size: 10px; position: relative; margin: 2px; }
        .p-token { width: 15px; height: 15px; border-radius: 50%; position: absolute; }
        
        /* MEMORY */
        .mem-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mem-btn { width: 100px; height: 100px; border-radius: 10px; border: 3px solid #333; opacity: 0.5; cursor: pointer; }
        .mem-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 0 20px currentColor; border-color: white; }
        
        /* REFLEX */
        #reflex-btn { width: 200px; height: 200px; border-radius: 50%; background: #500; border: 5px solid white; font-size: 30px; color: white; cursor: pointer; }
        
        /* CLICKER */
        #clicker-btn { width: 200px; height: 100px; background: var(--neon-blue); border: none; font-size: 25px; font-weight: bold; cursor: pointer; border-radius: 10px; }
        .click-bar-container { width: 300px; height: 20px; background: #333; margin: 10px; border-radius: 10px; overflow: hidden; }
        .click-bar { height: 100%; background: lime; width: 0%; transition: width 0.1s; }

        /* MATH */
        #math-q { font-size: 60px; color: var(--neon-gold); margin-bottom: 20px; }
        .math-opt { padding: 15px; font-size: 20px; width: 80px; margin: 5px; cursor: pointer; background: #333; border: 1px solid #555; color: white; }

        /* --- RESTO DO CSS PADRAO --- */
        #betting-modal, #voting-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .vote-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 800px; padding: 10px; }
        .vote-btn, .bet-btn { background: #222; border: 2px solid #555; color: white; padding: 15px; cursor: pointer; text-transform: uppercase; }
        .bet-btn.selected { background: var(--neon-green); color: black; }
        
        #game-interface { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { height: 50px; background: #111; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 250px; background: #0a0a0a; overflow-y: auto; padding: 10px; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rooms-grid { display: grid; gap: 10px; padding: 20px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .room-btn { aspect-ratio: 1; background: #1e1e1e; border: 1px solid #333; border-radius: 8px; color: #555; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .room-btn.gas { background: #2e1e05; border-color: #d35400; }
        .room-btn.life { background: #052e05; border-color: #27ae60; }
        .room-btn.escudo { background: #002233; border-color: #00b0ff; }
        .player-item { background: #151515; padding: 5px; margin-bottom: 2px; border-radius: 3px; display: flex; justify-content: space-between; font-size: 12px; }
        .player-item.dead { text-decoration: line-through; opacity: 0.5; }
        #victory-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        #main-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050505; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="mg-board" class="minigame-overlay">
        <div class="mg-title">üé≤ TABULEIRO</div>
        <div class="mg-vs" id="board-vs"></div>
        <div id="board-track" style="display:flex; flex-wrap:wrap; width:300px;"></div>
        <button id="dice-btn" onclick="socket.emit('pedirDado')" style="font-size:30px; margin-top:20px;">üé≤</button>
        <div id="board-msg" style="color:gold; height:20px;"></div>
    </div>

    <div id="mg-memory" class="minigame-overlay">
        <div class="mg-title">üß† MEM√ìRIA</div>
        <div class="mg-vs" id="mem-status">OBSERVE...</div>
        <div class="mem-grid">
            <div class="mem-btn" style="background:red" id="memb-0" onclick="sendMem(0)"></div>
            <div class="mem-btn" style="background:blue" id="memb-1" onclick="sendMem(1)"></div>
            <div class="mem-btn" style="background:green" id="memb-2" onclick="sendMem(2)"></div>
            <div class="mem-btn" style="background:yellow" id="memb-3" onclick="sendMem(3)"></div>
        </div>
    </div>

    <div id="mg-reflex" class="minigame-overlay">
        <div class="mg-title">‚ö° REFLEXO</div>
        <button id="reflex-btn" onmousedown="socket.emit('cliqueReflex')">ESPERE...</button>
        <div style="margin-top:20px;">CLIQUE NO VERDE!</div>
    </div>

    <div id="mg-clicker" class="minigame-overlay">
        <div class="mg-title">üëÜ ESMAGA BOT√ÉO</div>
        <button id="clicker-btn" onmousedown="socket.emit('clickerHit')">CLICK!</button>
        <div id="clicker-bars" style="margin-top:20px;"></div>
    </div>

    <div id="mg-math" class="minigame-overlay">
        <div class="mg-title">üßÆ MATEM√ÅTICA</div>
        <div id="math-q">? + ?</div>
        <div id="math-opts" style="display:flex;"></div>
    </div>

    <div id="voting-modal">
        <h2 style="color:cyan">QUEM VAI PRO PARED√ÉO?</h2>
        <div class="vote-grid" id="vote-list"></div>
    </div>

    <div id="betting-modal">
        <h2 style="color:gold">APOSTE NO VENCEDOR</h2>
        <div style="display:flex; gap:20px;">
            <div class="bet-btn" id="bet-p1" onclick="apostar(1)">P1</div>
            <div class="bet-btn" id="bet-p2" onclick="apostar(2)">P2</div>
        </div>
    </div>

    <div id="main-menu">
        <h1 style="color:lime; font-size:50px;">SURVIVAL 5-GAMES</h1>
        <input id="my-name" placeholder="Nome" style="padding:10px; font-size:20px;">
        <button onclick="entrar()" style="padding:10px; font-size:20px; margin-top:10px;">JOGAR</button>
    </div>

    <div id="game-interface">
        <div id="header">
            <button onclick="location.reload()">SAIR</button>
            <div style="color:white">VIVOS: <span id="alive-txt">0</span></div>
        </div>
        <div id="main-container">
            <div id="sidebar"><div id="players-list"></div></div>
            <div id="game-area"><div id="message-box" style="font-size:30px; font-weight:bold; height:40px;"></div><div id="rooms-grid"></div></div>
        </div>
    </div>

    <div id="victory-screen">
        <h1 style="color:gold">VENCEDOR</h1>
        <h2 id="win-name" style="color:white"></h2>
        <button onclick="location.reload()">VOLTAR</button>
    </div>

    <script>
        const socket = io();
        let meuId = null, canClickMem = false, apostaIds={};
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(f,t,d){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}
        
        socket.on('connect', ()=>meuId=socket.id);
        
        function entrar(){
            let n = document.getElementById('my-name').value;
            if(!n) return;
            socket.emit('entrar', {nome:n, tipo:'p1'});
            document.getElementById('main-menu').style.display='none';
            document.getElementById('game-interface').style.display='flex';
            // Se sou host (primeiro), inicio auto ou botao
            setTimeout(()=>socket.emit('iniciarJogo'), 2000); 
        }

        // START GAMES
        socket.on('iniciarMinigameUI', (d) => {
            document.querySelectorAll('.minigame-overlay').forEach(e=>e.style.display='none');
            
            if(d.type === 'BOARD') {
                document.getElementById('mg-board').style.display='flex';
                document.getElementById('board-vs').innerText = `${d.p1.nome} vs ${d.p2.nome}`;
                let tk = document.getElementById('board-track'); tk.innerHTML='';
                for(let i=0; i<=20; i++){
                    let div=document.createElement('div'); div.className='board-cell'; div.innerText=i;
                    div.id=`bc-${i}`; tk.appendChild(div);
                }
            }
            if(d.type === 'MEMORY') {
                document.getElementById('mg-memory').style.display='flex';
                canClickMem = false;
            }
            if(d.type === 'REFLEX') {
                document.getElementById('mg-reflex').style.display='flex';
                document.getElementById('reflex-btn').style.background='#500';
                document.getElementById('reflex-btn').innerText="ESPERE...";
            }
            if(d.type === 'CLICKER') {
                document.getElementById('mg-clicker').style.display='flex';
                document.getElementById('clicker-bars').innerHTML = `
                    <div style="color:white">${d.p1.nome}</div><div class="click-bar-container"><div class="click-bar" id="cb-${d.p1.id}"></div></div>
                    <div style="color:white">${d.p2.nome}</div><div class="click-bar-container"><div class="click-bar" id="cb-${d.p2.id}"></div></div>
                `;
            }
            if(d.type === 'MATH') {
                document.getElementById('mg-math').style.display='flex';
                document.getElementById('math-q').innerText = d.q + " = ?";
                let opts = document.getElementById('math-opts'); opts.innerHTML='';
                let res = eval(d.q);
                let arr = [res, res+1, res-1, res+2].sort(()=>Math.random()-0.5);
                arr.forEach(v => {
                    let b = document.createElement('button'); b.className='math-opt'; b.innerText=v;
                    b.onclick = () => socket.emit('mathResp', v);
                    opts.appendChild(b);
                });
            }
        });

        socket.on('fimMinigameUI', () => document.querySelectorAll('.minigame-overlay').forEach(e=>e.style.display='none'));

        // BOARD
        socket.on('boardVez', (d) => { document.getElementById('board-msg').innerText = d.id===meuId ? "SUA VEZ!" : "VEZ DO OPONENTE"; });
        socket.on('boardDado', (d) => {
            playTone(400,'square',0.1);
            document.querySelectorAll('.board-cell').forEach(e=>e.style.background='#222');
            document.getElementById(`bc-${d.pos}`).style.background='gold';
        });

        // MEMORY
        socket.on('memoryShow', (seq) => {
            canClickMem=false; document.getElementById('mem-status').innerText="OBSERVE";
            seq.forEach((c, i) => {
                setTimeout(()=>{
                    let b = document.getElementById(`memb-${c}`); b.classList.add('active'); playTone(500+c*100,'sine',0.1);
                    setTimeout(()=>b.classList.remove('active'), 400);
                }, 500 + i*800);
            });
            setTimeout(()=>{ canClickMem=true; document.getElementById('mem-status').innerText="SUA VEZ"; }, 500 + seq.length*800);
        });
        function sendMem(c){ if(canClickMem){ playTone(600,'sine',0.1); socket.emit('memoryInput', c); } }

        // REFLEX
        socket.on('reflexGo', () => {
            let b = document.getElementById('reflex-btn');
            b.style.background = '#0f0'; b.innerText = "CLIQUE!"; playTone(800,'square',0.2);
        });

        // CLICKER
        socket.on('clickerUpdate', (d) => {
            let bar = document.getElementById(`cb-${d.id}`);
            if(bar) bar.style.width = (d.val * 5) + "%"; // 20 clicks = 100%
        });

        // VOTING
        socket.on('abrirVotacao', (list) => {
            document.getElementById('voting-modal').style.display='flex';
            let g = document.getElementById('vote-list'); g.innerHTML='';
            list.forEach(p => {
                let b = document.createElement('button'); b.className='vote-btn'; b.innerText=p.nome;
                b.onclick = () => { socket.emit('enviarVoto', p.id); document.getElementById('voting-modal').style.display='none'; };
                g.appendChild(b);
            });
        });
        socket.on('fecharVotacao', ()=>document.getElementById('voting-modal').style.display='none');

        // BETTING
        socket.on('abrirApostasUI', (d) => {
            apostaIds = {1: d.p1.id, 2: d.p2.id};
            document.getElementById('betting-modal').style.display='flex';
            document.getElementById('bet-p1').innerText=d.p1.nome; document.getElementById('bet-p2').innerText=d.p2.nome;
        });
        function apostar(n){ socket.emit('fazerAposta', apostaIds[n]); document.getElementById('betting-modal').style.display='none'; }
        socket.on('fecharApostasUI', ()=>document.getElementById('betting-modal').style.display='none');

        // CORE
        socket.on('atualizarLista', (list) => {
            let d = document.getElementById('players-list'); d.innerHTML='';
            list.forEach(p => {
                let el = document.createElement('div'); el.className = `player-item ${p.vivo?'':'dead'}`;
                el.innerText = `${p.nome} ${p.temEscudo?'üõ°Ô∏è':''} ${p.vivo?'‚ù§Ô∏è'+p.vidas:'üíÄ'}`;
                if(p.id===meuId) el.style.color='lime';
                d.appendChild(el);
            });
            document.getElementById('alive-txt').innerText = list.filter(p=>p.vivo).length;
        });

        socket.on('inicioDePartida', (d) => renderRooms(d.salas));
        socket.on('novaRodada', (d) => { renderRooms(d.salas); document.getElementById('message-box').innerText=`RODADA ${d.fase}`; });
        socket.on('salaOcupada', (d) => {
            let b = document.getElementById(`room-${d.idSala}`);
            if(b){ b.style.background='#333'; b.innerText=d.efeito; }
        });
        socket.on('mensagem', (d) => { let m=document.getElementById('message-box'); m.innerText=d.texto; m.style.color=d.cor; });
        socket.on('mudancaDeTurno', (d) => { if(d.idJogador===meuId) document.getElementById('message-box').innerText="SUA VEZ DE ESCOLHER SALA!"; });
        socket.on('fimDeJogo', (d) => { document.getElementById('victory-screen').style.display='flex'; document.getElementById('win-name').innerText=d.campeao.nome; });

        function renderRooms(salas){
            let g = document.getElementById('rooms-grid'); g.innerHTML='';
            let cols = window.innerWidth<600?4:5; g.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
            salas.forEach(s => {
                let b = document.createElement('button'); b.className='room-btn'; b.id=`room-${s.id}`;
                b.onclick = () => socket.emit('jogarTurno', s.id);
                b.innerText = s.id; g.appendChild(b);
            });
        }
    </script>
</body>
</html>
